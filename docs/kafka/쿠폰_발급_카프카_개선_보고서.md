# 쿠폰 발급 Kafka 개선 보고서

## 1. 개요

기존 Redis SortedSet 기반 쿠폰 발급 시스템을 Kafka 중심으로 변경하여 대용량 트래픽 처리 성능을 개선했습니다. Redis의 복잡한 선착순 처리 로직을 제거하고 Kafka의 순서 보장 기능을 활용했습니다.

## 2. 기존 시스템의 문제점

### 2-1) Redis 기반 시스템의 한계
- **동시성 제어 복잡성**: Redis Sorted Set과 분산 락을 통한 복잡한 동시성 제어
- **배치 처리 지연**: 3초마다 스케줄러가 Redis → DB 동기화로 인한 지연
- **Redis 부하**: Sorted Set 연산, 배치 스캔으로 인한 Redis 서버 부하
- **복구 복잡성**: 배치 처리 중 예외 발생 시 복구 로직의 복잡성
### 2-2) 성능 병목
- 높은 트래픽 시 Redis 락 경합으로 인한 응답 지연
- 배치 처리로 인한 실시간성 부족

## 3. Kafka 중심 개선 방안

### 3-1) 아키텍처 변경
```
기존: 사용자 요청 → Redis SortedSet 처리 → 배치 스케줄러 → DB 저장
개선: 사용자 요청 → DB 검증 → Kafka 이벤트 발행 → 비동기 DB 저장
```

### 3-2) 개선 사항
- **Redis SortedSet 제거**: 복잡한 선착순 처리 로직 제거
- **Kafka 활용**: 순서 보장, 메시지 내구성, 확장성
- **로직 단순화**: DB 검증 + Kafka 발행으로 단순화

### 3-3) 주요 컴포넌트

#### **DB 기반 검증**
- **재고 확인**: CouponPolicy 테이블에서 실시간 재고 확인
- **중복 방지**: Coupon 테이블에서 사용자별 발급 이력 확인

#### **CouponIssueEventPublisher**
- DB 검증 통과 후 쿠폰 발급 요청을 Kafka 이벤트로 발행
- 순서 정보(sequenceNumber)를 포함한 메시지 생성

#### **CouponIssueEventListener**
- Kafka 메시지를 수신하여 실제 쿠폰 발급 처리
- `@KafkaListener`를 통한 비동기 메시지 처리

#### **CouponIssueMessage**
- 쿠폰 발급 요청 데이터 구조
- userId, policyId, requestedAt, sequenceNumber 필드 포함

## 4. 비즈니스 시퀀스 다이어그램
![카프카_쿠폰발급_시퀀스다이어그램.png](%EC%B9%B4%ED%94%84%EC%B9%B4_%EC%BF%A0%ED%8F%B0%EB%B0%9C%EA%B8%89_%EC%8B%9C%ED%80%80%EC%8A%A4%EB%8B%A4%EC%9D%B4%EC%96%B4%EA%B7%B8%EB%9E%A8.png)


## 5. Kafka 구성

### 토픽 정보
- **토픽명**: `coupon-issue-request`
- **파티션**: 3개 (확장성 고려)
- **리플리케이션**: 3개 (고가용성)
- **컨슈머 그룹**: `coupon-issue-group`

## 6. 구현 코드

### 6-1) 이벤트 발행자
```java
@Component
@RequiredArgsConstructor
public class CouponIssueEventPublisher {
    private final MessageClient messageClient;

    public void publishCouponIssueRequest(long userId, int policyId, long sequenceNumber) {
        CouponIssueMessage message = new CouponIssueMessage(userId, policyId, LocalDateTime.now(), sequenceNumber);
        String key = String.valueOf(sequenceNumber); // 순서 기반 파티션 키
        messageClient.send(Topics.COUPON_ISSUE_REQUEST, key, message);
    }
}
```

### 6-2) 이벤트 리스너
```java
@Component
@RequiredArgsConstructor
public class CouponIssueEventListener {
    private final ObjectMapper objectMapper;
    private final CouponService couponService;

    @KafkaListener(topics = "coupon-issue-request", groupId = "coupon-issue-group")
    public void handleCouponIssueRequest(String message) {
        try {
            CouponIssueMessage couponIssueMessage = objectMapper.readValue(message, CouponIssueMessage.class);
            
            // 쿠폰 발급 처리
            couponService.processCouponIssue(couponIssueMessage.userId(), couponIssueMessage.policyId());
            
        } catch (Exception e) {
            // 예외 처리
        }
    }
}
```

### 6-3) 서비스 로직 (Kafka 활용)
```java
public CouponIssueResult requestCoupon(int userId, int policyId) {
    CouponPolicy policy = getCouponPolicyById(policyId);
    
    // 1. DB 재고 확인
    if (policy.getIssuedCount() >= policy.getMaxCount()) {
        return CouponIssueResult.SOLD_OUT;
    }
    
    // 2. DB 중복 발급 방지
    List<Coupon> userCoupons = couponRepository.findByUserId(userId);
    boolean alreadyIssued = userCoupons.stream()
        .anyMatch(coupon -> coupon.getPolicyId() == policyId);
    
    if (alreadyIssued) {
        return CouponIssueResult.ALREADY_ISSUED;
    }
    
    // 3. Kafka로 쿠폰 발급 요청 이벤트 발행 (순서는 Kafka가 보장)
    long sequenceNumber = System.currentTimeMillis();
    couponIssueEventPublisher.publishCouponIssueRequest(userId, policyId, sequenceNumber);
    
    return CouponIssueResult.SUCCESS;
}
```

## 7. 개선 효과

### 7-1) 성능 개선
- **순서 보장**: Kafka 파티션 내 순서 보장으로 정확한 선착순 처리
- **응답 속도**: 복잡한 Redis 로직 제거로 응답 속도 향상
- **처리량**: Kafka의 높은 처리량으로 대용량 트래픽 처리 가능

### 7-2) 안정성 개선
- **로직 단순화**: 복잡한 Redis SortedSet 로직 제거로 안정성 향상
- **장애 격리**: Kafka의 내구성으로 메시지 손실 방지
- **재시도**: Kafka의 자동 재시도 메커니즘

### 7-3) 운영 효율성
- **코드 단순화**: Redis 의존성 제거로 코드 복잡도 감소
- **유지보수**: 명확한 책임 분리 (DB: 검증, Kafka: 처리)
- **확장성**: Kafka 파티션 기반 수평 확장 가능


## 8. 결론

Redis SortedSet 기반 쿠폰 발급 시스템을 Kafka 중심으로 변경하여 대용량 트래픽 처리 성능을 개선했습니다. 복잡한 Redis 로직을 제거하고 Kafka의 순서 보장 기능을 활용하여, 단순하고 확장 가능한 시스템을 구축했습니다.

### 개선 결과
- **순서 보장**: Kafka 파티션 내 순서 보장으로 정확한 선착순 처리
- **로직 단순화**: 복잡한 Redis SortedSet 로직 제거
- **성능 개선**: 응답 속도 향상 및 처리량 증가
- **확장성**: Kafka 파티션 기반 수평 확장 가능
